<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>载人电梯跨场景智能调度模拟平台</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
            danger: '#ef4444',
            warning: '#f59e0b',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .animate-bounce-slow {
        animation: bounce 2s infinite;
      }
      .transition-transform-slow {
        transition: transform 0.5s linear;
      }
      .glass {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      }
      .glass-dark {
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
      }
      .glass-blue {
        background: rgba(59, 130, 246, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.2);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
      }
      .glass-emerald {
        background: rgba(16, 185, 129, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }
      .glass-amber {
        background: rgba(245, 158, 11, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(245, 158, 11, 0.2);
      }
      .glass-red {
        background: rgba(239, 68, 68, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }
    }
    
    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(241, 245, 249, 0.3);
      backdrop-filter: blur(5px);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(203, 213, 225, 0.6);
      border-radius: 3px;
      backdrop-filter: blur(5px);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.8);
    }
    
    /* 电梯动画 */
    @keyframes elevator-move {
      from { transform: translateY(var(--from-y)); }
      to { transform: translateY(var(--to-y)); }
    }
    
    /* 脉冲动画 */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* 弹跳动画 */
    @keyframes bounce {
      0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
      50% { transform: none; animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
    }
    .animate-bounce {
      animation: bounce 1s infinite;
    }
    
    /* 渐变背景 */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    
    /* 按钮悬停效果 */
    button {
      transition: all 0.3s ease;
    }
    
    /* 电梯井道背景 */
    .elevator-shaft {
      background: linear-gradient(to bottom, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    }
    
    /* 电梯轿厢效果 */
    .elevator-car {
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
      border-radius: 4px;
    }
    
    /* 滑块样式 */
    input[type="range"] {
      background: rgba(241, 245, 249, 0.6);
      backdrop-filter: blur(5px);
    }
    
    input[type="range"]::-webkit-slider-thumb {
      background: rgba(59, 130, 246, 0.8);
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    /* 下拉框样式 */
    select {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1);
    }
  </style>
</head>
<body class="min-h-screen text-slate-800 font-sans flex flex-col">
  <!-- Header -->
  <header class="glass-dark text-white p-4 shadow-lg flex justify-between items-center z-20 border-b border-white/10">
    <div class="flex items-center gap-3">
      <i class="fa fa-line-chart text-blue-400 text-xl"></i>
      <h1 class="text-xl font-bold tracking-wide">载人电梯跨场景智能调度模拟平台</h1>
    </div>
    <div class="flex gap-2">
      <button id="scenario-office" class="scenario-btn flex items-center gap-2 px-4 py-2 rounded-md transition-all glass-blue text-white shadow-lg scale-105 border border-blue-500/30">
        <i class="fa fa-briefcase"></i>
        <span class="font-medium">高端办公楼</span>
      </button>
      <button id="scenario-hospital" class="scenario-btn flex items-center gap-2 px-4 py-2 rounded-md transition-all glass text-slate-700 hover:bg-white/30 border border-white/20">
        <i class="fa fa-plus-square"></i>
        <span class="font-medium">医疗建筑</span>
      </button>
      <button id="scenario-hotel" class="scenario-btn flex items-center gap-2 px-4 py-2 rounded-md transition-all glass text-slate-700 hover:bg-white/30 border border-white/20">
        <i class="fa fa-building"></i>
        <span class="font-medium">星级酒店</span>
      </button>
      <button id="scenario-residential" class="scenario-btn flex items-center gap-2 px-4 py-2 rounded-md transition-all glass text-slate-700 hover:bg-white/30 border border-white/20">
        <i class="fa fa-home"></i>
        <span class="font-medium">高层住宅</span>
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Left Panel: Controls & Info -->
    <div class="w-80 glass shadow-xl flex flex-col z-10 border-r border-white/20">
      <div class="p-6 border-b border-white/20 glass-blue">
        <h2 class="text-lg font-bold text-blue-900 mb-2 flex items-center gap-2">
          <i id="scenario-icon" class="fa fa-briefcase"></i>
          <span id="scenario-name">高端办公楼</span>
        </h2>
        <p id="scenario-description" class="text-sm text-slate-600 leading-relaxed glass p-3 rounded-lg border border-white/30 shadow-sm">
          追求极致吞吐效率，采用目的层算法，快速进出，限制最高等待时间。
        </p>
      </div>

      <div class="p-6 flex-1 overflow-y-auto">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
          <i class="fa fa-cog"></i> 建筑与物理参数
        </h3>
        
        <div class="space-y-5">
          <div>
            <label class="flex justify-between text-sm font-medium text-slate-700 mb-1">
              <span>楼层总数 (Floors)</span>
              <span id="num-floors-value" class="text-blue-600">15层</span>
            </label>
            <input id="num-floors" type="range" min="5" max="30" value="15" disabled
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" />
          </div>

          <div>
            <label class="flex justify-between text-sm font-medium text-slate-700 mb-1">
              <span>电梯数量 (Shafts)</span>
              <span id="num-elevators-value" class="text-blue-600">6部</span>
            </label>
            <input id="num-elevators" type="range" min="1" max="12" value="6" disabled
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" />
          </div>

          <div>
            <label class="flex justify-between text-sm font-medium text-slate-700 mb-1">
              <span>电梯组数 (Groups)</span>
              <span id="num-groups-value" class="text-blue-600">1组</span>
            </label>
            <input id="num-groups" type="range" min="1" max="4" value="1" disabled
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" />
          </div>

          <div>
            <label class="flex justify-between text-sm font-medium text-slate-700 mb-1">
              <span>组间距 (Group Spacing)</span>
              <span id="group-spacing-value" class="text-blue-600">3单位</span>
            </label>
            <input id="group-spacing" type="range" min="1" max="8" value="3" disabled
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" />
          </div>

          <div class="glass p-3 rounded-lg border border-white/30 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-slate-500">算法模型:</span>
              <span id="algorithm-model" class="font-mono font-bold text-slate-800">DCS</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-slate-500">轿厢容量:</span>
              <span id="capacity-value" class="font-mono text-slate-800">15 人/床</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-slate-500">开门停留:</span>
              <span id="door-time-value" class="font-mono text-slate-800">4 Tick</span>
            </div>
          </div>

          <div>
            <label class="flex justify-between text-sm font-medium text-slate-700 mb-1">
              <span>客流密度 (Traffic)</span>
              <span id="traffic-value" class="text-blue-600">x1</span>
            </label>
            <input id="traffic-multiplier" type="range" min="0.5" max="3" step="0.5" value="1"
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
          </div>

          <div>
            <label class="flex justify-between text-sm font-medium text-slate-700 mb-1">
              <span>运行模式 (Operating Mode)</span>
            </label>
            <select id="operating-mode" class="w-full bg-slate-100 border border-slate-200 rounded-lg p-2 text-sm text-slate-700 outline-none focus:border-blue-500 transition-colors">
              <option value="peak-up">早高峰 (大量上行)</option>
              <option value="peak-down">下班高峰 (大量下行)</option>
              <option value="balanced">平稳时段 (随机楼层)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="glass p-4 border-t border-white/20">
         <div class="text-sm font-bold text-slate-500 mb-2">时间模拟速度</div>
         <div class="flex gap-2">
           <button id="speed-1x" class="speed-btn flex-1 py-1.5 text-xs font-bold rounded-md border transition-all glass-blue text-blue-700 shadow-md border-blue-500/30">1x</button>
           <button id="speed-10x" class="speed-btn flex-1 py-1.5 text-xs font-bold rounded-md border transition-all glass text-slate-600 hover:bg-white/40 border-white/30">10x</button>
           <button id="speed-100x" class="speed-btn flex-1 py-1.5 text-xs font-bold rounded-md border transition-all glass text-slate-600 hover:bg-white/40 border-white/30">100x极速</button>
         </div>
      </div>

      <div class="p-6 border-t border-white/20 glass space-y-3">
         <div class="flex gap-2">
            <button id="toggle-simulation" class="flex-1 py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md glass-emerald hover:bg-emerald-500/25 text-emerald-700 border border-emerald-500/30">
              <i class="fa fa-play"></i> 开始模拟
            </button>
            <button id="reset-simulation" class="px-4 py-3 glass hover:bg-white/40 text-slate-700 rounded-lg font-bold flex items-center justify-center transition-all shadow-sm border border-white/30" title="重置">
              <i class="fa fa-refresh"></i>
            </button>
         </div>
         
         <button id="trigger-code-blue" class="w-full py-3 glass-red hover:bg-red-500/25 disabled:opacity-50 disabled:cursor-not-allowed text-red-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md animate-pulse border border-red-500/30" style="display: none;">
           <i class="fa fa-exclamation-triangle"></i> 触发 Code Blue 急救
         </button>
      </div>
    </div>

    <!-- Center Panel: Visualization -->
    <div class="flex-1 p-8 overflow-y-auto flex flex-col items-center">
      <div class="w-full max-w-4xl glass p-8 rounded-2xl shadow-xl border border-white/30 relative">
        
        <!-- 建筑物理可视化 -->
        <div id="building-visualization" class="relative border-b-4 border-slate-800" style="height: 600px;">
          <!-- 楼层线与楼层号 -->
          <div id="floors-container"></div>

          <!-- 电梯井与轿厢 -->
          <div id="elevators-container" class="absolute left-40 right-0 top-0 bottom-0 flex justify-around px-8"></div>
        </div>
        
        <div class="mt-8 flex justify-center gap-6 text-sm text-slate-600">
           <div class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-slate-400 bg-white rounded-sm"></div> 运行中</div>
           <div class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-amber-500 bg-amber-100 rounded-sm"></div> 开门停靠</div>
           <div class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-red-600 bg-red-100 rounded-sm"></div> 紧急抢占 (Code Blue)</div>
           <div class="flex items-center gap-2"><div class="w-2 h-4 bg-blue-400 rounded-sm"></div> 候梯乘客</div>
        </div>
      </div>
    </div>

    <!-- Right Panel: Analytics -->
    <div class="w-80 glass shadow-xl flex flex-col z-10 border-l border-white/20">
       <div class="p-6 border-b border-white/20 glass-dark text-white">
         <h2 class="text-lg font-bold flex items-center gap-2 mb-4">
           <i class="fa fa-bar-chart text-emerald-400"></i> 实时性能指标
         </h2>
         
         <div class="grid grid-cols-2 gap-4">
           <div class="glass-dark p-4 rounded-xl border border-white/10">
             <div class="text-xs text-slate-400 mb-1">平均等待时间</div>
             <div class="flex items-end gap-1">
                <span id="avg-wait-time" class="text-2xl font-bold text-emerald-400">0.0</span>
                <span class="text-xs text-slate-500 mb-1">秒(Tick)</span>
             </div>
             <div id="target-wait-time" class="text-[10px] text-slate-500 mt-1">目标: &lt;30s</div>
           </div>
           
           <div class="glass-dark p-4 rounded-xl border border-white/10">
             <div class="text-xs text-slate-400 mb-1">累计运送</div>
             <div class="flex items-end gap-1">
                <span id="served-count" class="text-2xl font-bold text-blue-400">0</span>
                <span class="text-xs text-slate-500 mb-1">人</span>
             </div>
             <div id="current-riding" class="text-[10px] text-slate-500 mt-1">当前承载: 0</div>
           </div>
         </div>
       </div>

       <div class="p-6 flex-1 space-y-6">
          <!-- 图表1: 等待时间趋势 -->
          <div>
             <h3 class="text-sm font-bold text-slate-700 mb-3">平均等待时间趋势 (对比目标)</h3>
             <div id="wait-time-chart" class="h-32 glass border border-white/30 rounded-lg p-2 relative flex items-end gap-1">
                <!-- 目标阈值线 -->
                <div id="target-line" class="absolute w-full border-t border-red-300 border-dashed left-0 z-0 flex items-center" style="bottom: 30%;">
                   <span class="absolute -top-4 right-1 text-[10px] text-red-400 bg-white px-1">阈值 30</span>
                </div>
                <div class="w-full h-full flex items-center justify-center text-xs text-slate-400">暂无数据</div>
             </div>
          </div>

          <!-- 状态监控 -->
          <div>
             <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fa fa-users"></i> 实时排队监控</h3>
             <div id="queue-monitor" class="space-y-2 glass p-3 rounded-lg border border-white/30">
                <div class="text-xs text-slate-500 text-center py-4">当前无排队乘客</div>
             </div>
          </div>
       </div>
    </div>
  </div>

  <script>
    // --- 预设场景配置数据 (基于文献) ---
    const SCENARIO_CONFIGS = {
      office: {
        id: 'office',
        name: '高端办公楼',
        icon: 'fa-briefcase',
        defaultFloors: 15,
        defaultElevators: 6,
        capacity: 15, // 人
        doorDwellTime: 4, // 较快开门时间
        targetWaitTime: 30, // 目标等待时间(秒)
        algorithm: 'DCS', // 目的层群控
        defaultMode: 'peak-up',
        modes: [
          { id: 'peak-up', name: '早高峰 (大量上行)', spawnMultiplier: 1.5, pattern: 'up' },
          { id: 'peak-down', name: '下班高峰 (大量下行)', spawnMultiplier: 1.5, pattern: 'down' },
          { id: 'balanced', name: '平稳时段 (随机楼层)', spawnMultiplier: 1.0, pattern: 'random' }
        ],
        description: '追求极致吞吐效率，采用目的层算法，快速进出，限制最高等待时间。'
      },
      hospital: {
        id: 'hospital',
        name: '医疗建筑(医院)',
        icon: 'fa-plus-square',
        defaultFloors: 8,
        defaultElevators: 5,
        capacity: 20, // 容纳病床，载重更大
        doorDwellTime: 7, // 强制延长至7秒以上
        targetWaitTime: 45,
        algorithm: 'Preemptive', // 抢占式调度
        defaultMode: 'balanced',
        modes: [
          { id: 'balanced', name: '日间平稳 (双向客流)', spawnMultiplier: 1.2, pattern: 'random' },
          { id: 'morning-rush', name: '早门诊高峰 (大量上行)', spawnMultiplier: 1.6, pattern: 'up' },
          { id: 'night', name: '夜间值班 (低客流)', spawnMultiplier: 0.3, pattern: 'random' }
        ],
        description: '生命保障通道。轿厢宽大。支持 Code Blue 紧急抢占，强制中断常规呼叫。'
      },
      hotel: {
        id: 'hotel',
        name: '星级酒店',
        icon: 'fa-building',
        defaultFloors: 12,
        defaultElevators: 4,
        capacity: 12,
        doorDwellTime: 5,
        targetWaitTime: 40,
        algorithm: 'Standby-Lobby', // 闲置返回大堂
        defaultMode: 'balanced',
        modes: [
          { id: 'balanced', name: '平稳时段 (随机起降)', spawnMultiplier: 1.0, pattern: 'random' },
          { id: 'checkin', name: '下午入住 (大量上行)', spawnMultiplier: 1.3, pattern: 'up' },
          { id: 'checkout', name: '早间退房 (大量下行)', spawnMultiplier: 1.4, pattern: 'down' }
        ],
        description: '注重隐私与舒适。闲置电梯倾向于返回首层大堂待机(入住模式)。'
      },
      residential: {
        id: 'residential',
        name: '高层住宅',
        icon: 'fa-home',
        defaultFloors: 20,
        defaultElevators: 3, // 得房率优先，梯户比低
        capacity: 10,
        doorDwellTime: 5,
        targetWaitTime: 55, // 容忍度最高
        algorithm: 'SCAN', // 基础集选
        defaultMode: 'balanced',
        modes: [
          { id: 'balanced', name: '日间平稳 (随机起降)', spawnMultiplier: 0.8, pattern: 'random' },
          { id: 'peak-down', name: '早高峰 (下行出门)', spawnMultiplier: 1.5, pattern: 'down' },
          { id: 'peak-up', name: '晚高峰 (上行回家)', spawnMultiplier: 1.3, pattern: 'up' }
        ],
        description: '强调经济与基础公平调度，客流相对平缓，容忍等待时间较长。'
      }
    };

    // --- 全局状态 ---
    let state = {
      scenario: 'office',
      isRunning: false,
      tick: 0,
      numFloors: SCENARIO_CONFIGS['office'].defaultFloors,
      numElevators: SCENARIO_CONFIGS['office'].defaultElevators,
      numGroups: 1, // 电梯组数
      groupSize: SCENARIO_CONFIGS['office'].defaultElevators, // 每组电梯数量
      groupSpacing: 3, // 组间距（单位：电梯宽度）
      trafficMultiplier: 1,
      simSpeed: 1,
      currentMode: SCENARIO_CONFIGS['office'].defaultMode,
      elevators: [],
      passengers: [],
      stats: {
        servedCount: 0,
        totalWaitTime: 0,
        totalTravelTime: 0,
        waitHistory: [],
        throughputHistory: []
      },
      interval: null
    };

    // --- 辅助函数 ---
    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    // --- 初始化/重置系统 ---
    function resetSimulation() {
      state.isRunning = false;
      state.tick = 0;
      
      const config = SCENARIO_CONFIGS[state.scenario];
      
      // 确保电梯数量和组数、每组数量匹配
      state.numGroups = Math.max(1, Math.min(state.numGroups, Math.ceil(state.numElevators / 2)));
      state.groupSize = Math.ceil(state.numElevators / state.numGroups);
      
      // 初始化电梯（支持分组）
      state.elevators = [];
      for (let group = 0; group < state.numGroups; group++) {
        const elevatorsInGroup = Math.min(state.groupSize, state.numElevators - state.elevators.length);
        for (let i = 0; i < elevatorsInGroup; i++) {
          const index = state.elevators.length;
          state.elevators.push({
            id: `E${index+1}`,
            groupId: `G${group+1}`,
            groupIndex: i,
            currentFloor: 0,
            targetFloor: null,
            direction: 'idle', // 'up', 'down', 'idle'
            state: 'idle', // 'idle', 'moving', 'doors_open', 'emergency'
            doorTimer: 0,
            passengers: [],
            capacity: config.capacity
          });
        }
      }
      
      state.passengers = [];
      state.stats = { 
        servedCount: 0, 
        totalWaitTime: 0, 
        totalTravelTime: 0, 
        waitHistory: [], 
        throughputHistory: [] 
      };
      
      // 更新UI
      updateUI();
      renderBuilding();
      renderElevators();
      renderPassengers();
      updateAnalytics();
    }

    // --- 核心模拟引擎 (Tick Loop) ---
    function startSimulation() {
      if (state.isRunning) return;
      
      state.isRunning = true;
      document.getElementById('toggle-simulation').innerHTML = '<i class="fa fa-pause"></i> 暂停模拟';
      document.getElementById('toggle-simulation').classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
      document.getElementById('toggle-simulation').classList.add('bg-amber-500', 'hover:bg-amber-600');
      
      // 动态计算Tick延迟时间
      const delay = Math.max(500 / state.simSpeed, 5);
      
      state.interval = setInterval(() => {
        state.tick++;
        runSimulationStep();
      }, delay);
    }

    function pauseSimulation() {
      if (!state.isRunning) return;
      
      state.isRunning = false;
      clearInterval(state.interval);
      document.getElementById('toggle-simulation').innerHTML = '<i class="fa fa-play"></i> 开始模拟';
      document.getElementById('toggle-simulation').classList.remove('bg-amber-500', 'hover:bg-amber-600');
      document.getElementById('toggle-simulation').classList.add('bg-emerald-500', 'hover:bg-emerald-600');
    }

    function runSimulationStep() {
      const config = SCENARIO_CONFIGS[state.scenario];
      const modeConfig = config.modes.find(m => m.id === state.currentMode) || config.modes[0];
      
      // 1. 乘客生成逻辑 (基于运行模式动态调节)
      const spawnRate = 0.15 * state.trafficMultiplier * modeConfig.spawnMultiplier;
      if (Math.random() < spawnRate) {
        let origin, dest;
        if (modeConfig.pattern === 'up') {
          // 上行模式 (如早高峰/入住)：70%的人从底层往上
          origin = Math.random() < 0.7 ? 0 : Math.floor(Math.random() * state.numFloors);
          dest = origin === 0 ? Math.floor(Math.random() * (state.numFloors - 1)) + 1 : 0;
        } else if (modeConfig.pattern === 'down') {
          // 下行模式 (如下班/退房)：70%的人从高层往下层
          origin = Math.random() < 0.7 ? Math.floor(Math.random() * (state.numFloors - 1)) + 1 : Math.floor(Math.random() * state.numFloors);
          dest = origin !== 0 ? 0 : Math.floor(Math.random() * (state.numFloors - 1)) + 1;
        } else {
          // 随机分布 (平稳时段)
          origin = Math.floor(Math.random() * state.numFloors);
          dest = Math.floor(Math.random() * state.numFloors);
          if (origin === dest) dest = (dest + 1) % state.numFloors;
        }
        
        state.passengers.push({
          id: generateId(),
          origin,
          dest,
          state: 'waiting', // waiting, boarding, riding, arrived
          spawnTick: state.tick,
          boardTick: null,
          arriveTick: null,
          isEmergency: false
        });
      }

      // 2. 电梯状态更新
      let newlyServed = 0;
      let newWaitTime = 0;
      
      state.elevators.forEach(elev => {
        // --- A. 状态更新 ---
        if (elev.state === 'doors_open') {
          elev.doorTimer -= 1;
          
          // 下车逻辑
          const arrivingPass = elev.passengers.filter(p => p.dest === elev.currentFloor);
          if (arrivingPass.length > 0) {
             arrivingPass.forEach(p => {
                const passRecord = state.passengers.find(up => up.id === p.id);
                if(passRecord) {
                    passRecord.state = 'arrived';
                    passRecord.arriveTick = state.tick;
                    newlyServed++;
                    newWaitTime += (passRecord.boardTick - passRecord.spawnTick);
                }
             });
             elev.passengers = elev.passengers.filter(p => p.dest !== elev.currentFloor);
          }

          // 上车逻辑
          const waitingAtFloor = state.passengers.filter(p => p.state === 'waiting' && p.origin === elev.currentFloor);
          let boarded = 0;
          
          waitingAtFloor.forEach(p => {
            if (elev.passengers.length < elev.capacity) {
              // 如果是紧急状态，只有紧急乘客能上车
              if(elev.state === 'emergency' && !p.isEmergency) return;
              
              // 基础方向判断：如果电梯有方向，只上同向的，除非电梯空了
              const passDir = p.dest > p.origin ? 'up' : 'down';
              if (elev.passengers.length === 0 || elev.direction === passDir || elev.direction === 'idle' || elev.state === 'emergency') {
                p.state = 'riding';
                p.boardTick = state.tick;
                elev.passengers.push(p);
                boarded++;
                // 确定电梯方向
                if(elev.passengers.length === 1) {
                    elev.direction = p.dest > elev.currentFloor ? 'up' : 'down';
                }
              }
            }
          });

          if (elev.doorTimer <= 0) {
            elev.state = 'idle'; // 门关上，变为idle，等待调度决策
            if(elev.passengers.length > 0) {
               elev.state = 'moving';
               elev.targetFloor = elev.direction === 'up' ? Math.max(...elev.passengers.map(p=>p.dest)) : Math.min(...elev.passengers.map(p=>p.dest));
            }
          }
          return; // 门开着时不移动
        }

        // --- B. 调度算法逻辑 ---
        const waitingPass = state.passengers.filter(p => p.state === 'waiting');
        
        if (elev.state === 'idle') {
           // 1. 医院 Code Blue 抢占逻辑
           if (config.algorithm === 'Preemptive') {
              const emergencyPass = waitingPass.find(p => p.isEmergency);
              if (emergencyPass) {
                 elev.state = 'emergency';
                 elev.targetFloor = emergencyPass.origin;
                 elev.direction = elev.targetFloor > elev.currentFloor ? 'up' : (elev.targetFloor < elev.currentFloor ? 'down' : 'idle');
                 return;
              }
           }

           if (elev.passengers.length === 0) {
             if (waitingPass.length > 0) {
               // 寻找最近的请求
               let bestPass = null;
               let minDiff = Infinity;
               
               // DCS 算法简化：倾向于分配给同方向或距离最近的
               waitingPass.forEach(p => {
                  const diff = Math.abs(p.origin - elev.currentFloor);
                  if(diff < minDiff) {
                      minDiff = diff;
                      bestPass = p;
                  }
               });

               if (bestPass) {
                  elev.targetFloor = bestPass.origin;
                  elev.state = 'moving';
                  elev.direction = elev.targetFloor > elev.currentFloor ? 'up' : (elev.targetFloor < elev.currentFloor ? 'down' : 'idle');
               }
             } else {
               // 闲置状态行为
               if (config.algorithm === 'Standby-Lobby' && elev.currentFloor !== 0) {
                  elev.targetFloor = 0;
                  elev.state = 'moving';
                  elev.direction = 'down';
               } else {
                  elev.direction = 'idle';
               }
             }
           }
        }

        // --- C. 移动逻辑 ---
        if (elev.state === 'moving' || elev.state === 'emergency') {
           if (elev.targetFloor > elev.currentFloor) {
              elev.currentFloor += 1;
              elev.direction = 'up';
           } else if (elev.targetFloor < elev.currentFloor) {
              elev.currentFloor -= 1;
              elev.direction = 'down';
           }

           // 检查是否需要停靠
           const hasAlighting = elev.passengers.some(p => p.dest === elev.currentFloor);
           const hasBoarding = state.passengers.some(p => p.state === 'waiting' && p.origin === elev.currentFloor && 
                                                      (elev.passengers.length === 0 || (p.dest > p.origin ? 'up' : 'down') === elev.direction));
           
           // 如果是紧急状态，只在紧急乘客所在楼层或其目标楼层停靠
           let shouldStop = hasAlighting || hasBoarding;
           if (elev.state === 'emergency') {
               const emPass = state.passengers.find(p => p.isEmergency);
               shouldStop = (emPass && emPass.origin === elev.currentFloor && emPass.state === 'waiting') || 
                            elev.passengers.some(p => p.isEmergency && p.dest === elev.currentFloor);
           }

           if (shouldStop || elev.currentFloor === elev.targetFloor) {
              elev.state = 'doors_open';
              elev.doorTimer = config.doorDwellTime;
              
              // 到达目的地后如果乘客空了，解除紧急状态
              if(elev.state === 'emergency' && elev.passengers.length === 0 && !state.passengers.some(p=>p.isEmergency && p.state === 'waiting')) {
                  elev.state = 'doors_open'; // 转为普通开门
              }
           }
        }
      });

      // --- 更新统计数据 ---
      if (newlyServed > 0) {
          state.stats.servedCount += newlyServed;
          state.stats.totalWaitTime += newWaitTime;
          const currentAvgWait = state.stats.totalWaitTime / state.stats.servedCount;
          state.stats.waitHistory = [...state.stats.waitHistory.slice(-19), currentAvgWait];
          state.stats.throughputHistory = [...state.stats.throughputHistory.slice(-19), newlyServed];
      }

      // 更新UI
      renderElevators();
      renderPassengers();
      updateAnalytics();
    }

    // --- 手动触发医院蓝色代码 (Code Blue) ---
    function triggerCodeBlue() {
      if (state.scenario !== 'hospital' || !state.isRunning) return;
      
      const origin = Math.floor(Math.random() * (state.numFloors - 1)) + 1; // 随机非底层楼层
      const dest = 0; // 通常急救去底层手术室/急诊
      
      state.passengers.push({
        id: `EMG-${generateId()}`,
        origin,
        dest,
        state: 'waiting',
        spawnTick: state.tick,
        boardTick: null,
        arriveTick: null,
        isEmergency: true
      });
      
      renderPassengers();
    }

    // --- UI 渲染函数 ---
    function updateUI() {
      const config = SCENARIO_CONFIGS[state.scenario];
      
      // 更新场景信息
      document.getElementById('scenario-name').textContent = config.name;
      document.getElementById('scenario-icon').className = `fa ${config.icon}`;
      document.getElementById('scenario-description').textContent = config.description;
      
      // 更新参数显示
      document.getElementById('num-floors-value').textContent = `${state.numFloors}层`;
      document.getElementById('num-elevators-value').textContent = `${state.numElevators}部`;
      document.getElementById('algorithm-model').textContent = config.algorithm;
      document.getElementById('capacity-value').textContent = `${config.capacity} 人/床`;
      document.getElementById('door-time-value').textContent = `${config.doorDwellTime} Tick`;
      document.getElementById('traffic-value').textContent = `x${state.trafficMultiplier}`;
      document.getElementById('target-wait-time').textContent = `目标: <${config.targetWaitTime}s`;
      
      // 更新目标线
      const targetLine = document.getElementById('target-line');
      targetLine.style.bottom = `${(config.targetWaitTime / 100) * 100}%`;
      targetLine.querySelector('span').textContent = `阈值 ${config.targetWaitTime}`;
      
      // 更新运行模式下拉框
      const modeSelect = document.getElementById('operating-mode');
      modeSelect.innerHTML = '';
      config.modes.forEach(mode => {
        const option = document.createElement('option');
        option.value = mode.id;
        option.textContent = mode.name;
        modeSelect.appendChild(option);
      });
      modeSelect.value = state.currentMode;
      
      // 显示/隐藏Code Blue按钮
      const codeBlueBtn = document.getElementById('trigger-code-blue');
      if (state.scenario === 'hospital') {
        codeBlueBtn.style.display = 'flex';
      } else {
        codeBlueBtn.style.display = 'none';
      }
      
      // 更新场景按钮样式
      document.querySelectorAll('.scenario-btn').forEach(btn => {
        const scenarioId = btn.id.replace('scenario-', '');
        if (scenarioId === state.scenario) {
          btn.classList.remove('bg-slate-800', 'text-slate-300', 'hover:bg-slate-700');
          btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'scale-105');
        } else {
          btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'scale-105');
          btn.classList.add('bg-slate-800', 'text-slate-300', 'hover:bg-slate-700');
        }
      });
      
      // 更新速度按钮样式
      document.querySelectorAll('.speed-btn').forEach(btn => {
        const speed = parseInt(btn.textContent);
        if (speed === state.simSpeed) {
          btn.classList.remove('bg-white', 'text-slate-600', 'hover:bg-slate-100');
          btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
        } else {
          btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
          btn.classList.add('bg-white', 'text-slate-600', 'hover:bg-slate-100');
        }
      });
      
      // 更新滑块值
      document.getElementById('num-floors').value = state.numFloors;
      document.getElementById('num-elevators').value = state.numElevators;
      document.getElementById('num-groups').value = state.numGroups;
      document.getElementById('group-spacing').value = state.groupSpacing;
      document.getElementById('traffic-multiplier').value = state.trafficMultiplier;
      
      // 更新显示值
      document.getElementById('num-floors-value').textContent = `${state.numFloors}层`;
      document.getElementById('num-elevators-value').textContent = `${state.numElevators}部`;
      document.getElementById('num-groups-value').textContent = `${state.numGroups}组`;
      document.getElementById('group-spacing-value').textContent = `${state.groupSpacing}单位`;
      document.getElementById('traffic-value').textContent = `x${state.trafficMultiplier}`;
      
      // 启用/禁用滑块
      document.getElementById('num-floors').disabled = state.isRunning;
      document.getElementById('num-elevators').disabled = state.isRunning;
      document.getElementById('num-groups').disabled = state.isRunning;
      document.getElementById('group-spacing').disabled = state.isRunning;
    }

    function renderBuilding() {
      const container = document.getElementById('floors-container');
      const buildingHeight = state.numFloors * 40;
      
      document.getElementById('building-visualization').style.height = `${buildingHeight}px`;
      container.innerHTML = '';
      
      // 渲染楼层
      for (let i = 0; i < state.numFloors; i++) {
        const floorNum = state.numFloors - 1 - i;
        const floorElement = document.createElement('div');
        floorElement.className = 'absolute w-full border-t border-dashed border-slate-300 flex items-center';
        floorElement.style.top = `${i * 40}px`;
        floorElement.style.height = '40px';
        floorElement.id = `floor-${floorNum}`;
        
        floorElement.innerHTML = `
          <div class="w-12 text-right pr-4 font-mono text-xs text-slate-400 border-r-2 border-slate-400 h-full flex items-center justify-end">
            F${floorNum}
          </div>
          <div class="pl-4 flex gap-1 items-center">
            <div id="waiting-indicator-${floorNum}"></div>
          </div>
        `;
        
        container.appendChild(floorElement);
      }
      
      // 渲染电梯井（支持分组和间距）
      const elevatorsContainer = document.getElementById('elevators-container');
      elevatorsContainer.innerHTML = '';
      
      // 按组排列电梯
      const elevatorsPerGroup = Math.ceil(state.numElevators / state.numGroups);
      const elevatorWidth = 56; // 电梯井宽度 (14 * 4px)
      const spacingWidth = elevatorWidth * state.groupSpacing;
      
      for (let group = 0; group < state.numGroups; group++) {
        const groupContainer = document.createElement('div');
        groupContainer.className = 'flex flex-col items-center';
        
        // 组标题
        const groupTitle = document.createElement('div');
        groupTitle.className = 'text-xs font-mono font-bold text-slate-600 mb-2 bg-white px-3 py-1 rounded-full border border-slate-300';
        groupTitle.textContent = `组 ${group + 1}`;
        groupContainer.appendChild(groupTitle);
        
        // 电梯井容器
        const shaftsContainer = document.createElement('div');
        shaftsContainer.className = 'flex items-center';
        
        // 该组的电梯
        const startIndex = group * elevatorsPerGroup;
        const endIndex = Math.min(startIndex + elevatorsPerGroup, state.numElevators);
        
        for (let i = startIndex; i < endIndex; i++) {
          const elevatorShaft = document.createElement('div');
          elevatorShaft.className = 'w-14 h-full border-x-2 border-slate-800/30 elevator-shaft relative shadow-inner glass';
          elevatorShaft.id = `elevator-shaft-${i}`;
          
          elevatorShaft.innerHTML = `
            <div class="absolute -top-6 w-full text-center text-xs font-mono font-bold text-slate-600 bg-white rounded-t-md border border-slate-300">
              E${i+1}
            </div>
            <div id="elevator-car-${i}" class="absolute left-[2px] right-[2px] rounded-sm transition-transform duration-500 ease-linear flex flex-col items-center justify-center elevator-car
            glass border-2 border-slate-400/30" style="height: 36px; transform: translateY(0);">
              <span class="text-[10px] font-bold text-slate-600">0F</span>
              <div class="flex gap-[2px] flex-wrap justify-center px-1" id="elevator-passengers-${i}"></div>
            </div>
          `;
          
          shaftsContainer.appendChild(elevatorShaft);
        }
        
        groupContainer.appendChild(shaftsContainer);
        elevatorsContainer.appendChild(groupContainer);
        
        // 添加组间距（最后一组除外）
        if (group < state.numGroups - 1) {
          const spacing = document.createElement('div');
          spacing.style.width = `${spacingWidth}px`;
          spacing.style.height = '100%';
          elevatorsContainer.appendChild(spacing);
        }
      }
    }

    function renderElevators() {
      state.elevators.forEach((elev, index) => {
        const elevatorCar = document.getElementById(`elevator-car-${index}`);
        const passengersContainer = document.getElementById(`elevator-passengers-${index}`);
        
        // 更新电梯位置
        const translateY = (state.numFloors - 1 - elev.currentFloor) * 40;
        elevatorCar.style.transform = `translateY(${translateY}px)`;
        
        // 更新电梯状态样式
        elevatorCar.className = `absolute left-[2px] right-[2px] rounded-sm transition-transform duration-500 ease-linear flex flex-col items-center justify-center elevator-car
          ${elev.state === 'emergency' ? 'glass-red border-2 border-red-500/50' : 
            elev.state === 'doors_open' ? 'glass-amber border-2 border-amber-500/50' : 
            'glass border-2 border-slate-400/30'}
        `;
        elevatorCar.style.height = '36px';
        
        // 更新楼层显示
        elevatorCar.querySelector('span').textContent = `${elev.currentFloor}F`;
        elevatorCar.querySelector('span').className = `text-[10px] font-bold ${elev.state === 'emergency' ? 'text-red-600' : 'text-slate-600'}`;
        
        // 更新乘客显示
        passengersContainer.innerHTML = '';
        elev.passengers.forEach((p, idx) => {
          const passengerDot = document.createElement('div');
          passengerDot.className = `w-1.5 h-1.5 rounded-full ${p.isEmergency ? 'bg-red-600' : 'bg-slate-700'}`;
          passengersContainer.appendChild(passengerDot);
        });
        
        // 门状态指示
        if (elev.state === 'doors_open') {
          if (!elevatorCar.querySelector('.door-indicator')) {
            const doorIndicator = document.createElement('div');
            doorIndicator.className = 'absolute inset-0 flex justify-between px-[1px] door-indicator';
            doorIndicator.innerHTML = `
              <div class="w-1 bg-amber-500/30 h-full"></div>
              <div class="w-1 bg-amber-500/30 h-full"></div>
            `;
            elevatorCar.appendChild(doorIndicator);
          }
        } else {
          const existingDoorIndicator = elevatorCar.querySelector('.door-indicator');
          if (existingDoorIndicator) {
            existingDoorIndicator.remove();
          }
        }
      });
    }

    function renderPassengers() {
      // 清除所有楼层的等待乘客指示
      for (let i = 0; i < state.numFloors; i++) {
        const indicator = document.getElementById(`waiting-indicator-${i}`);
        if (indicator) indicator.innerHTML = '';
      }
      
      // 按楼层分组乘客
      const passengersByFloor = {};
      state.passengers.filter(p => p.state === 'waiting').forEach(p => {
        if (!passengersByFloor[p.origin]) {
          passengersByFloor[p.origin] = [];
        }
        passengersByFloor[p.origin].push(p);
      });
      
      // 渲染每个楼层的等待乘客
      Object.keys(passengersByFloor).forEach(floorNum => {
        const indicator = document.getElementById(`waiting-indicator-${floorNum}`);
        if (!indicator) return;
        
        const passengers = passengersByFloor[floorNum];
        const hasEmergency = passengers.some(p => p.isEmergency);
        
        // 显示最多5个乘客点
        const visiblePassengers = passengers.slice(0, 5);
        visiblePassengers.forEach((p, idx) => {
          const passengerDot = document.createElement('div');
          passengerDot.className = `w-2 h-4 rounded-sm ${p.isEmergency ? 'bg-red-500 animate-bounce' : 'bg-blue-400'}`;
          indicator.appendChild(passengerDot);
        });
        
        // 如果超过5个，显示"+N"
        if (passengers.length > 5) {
          const moreText = document.createElement('span');
          moreText.className = 'text-xs text-slate-500 font-bold';
          moreText.textContent = `+${passengers.length - 5}`;
          indicator.appendChild(moreText);
        }
        
        // 如果有紧急乘客，显示警报
        if (hasEmergency) {
          const alertText = document.createElement('span');
          alertText.className = 'text-xs text-red-600 font-bold ml-2 flex items-center';
          alertText.innerHTML = '<i class="fa fa-exclamation-triangle" style="font-size: 12px;"></i> 抢救呼叫';
          indicator.appendChild(alertText);
        }
      });
      
      // 更新排队监控
      updateQueueMonitor();
    }

    function updateQueueMonitor() {
      const queueMonitor = document.getElementById('queue-monitor');
      const waitingPassengers = state.passengers.filter(p => p.state === 'waiting');
      
      if (waitingPassengers.length === 0) {
        queueMonitor.innerHTML = '<div class="text-xs text-slate-400 text-center py-4">当前无排队乘客</div>';
        return;
      }
      
      // 按楼层分组并排序
      const passengersByFloor = {};
      waitingPassengers.forEach(p => {
        if (!passengersByFloor[p.origin]) {
          passengersByFloor[p.origin] = [];
        }
        passengersByFloor[p.origin].push(p);
      });
      
      const sortedFloors = Object.keys(passengersByFloor).sort((a, b) => b - a);
      
      queueMonitor.innerHTML = '';
      sortedFloors.forEach(floorNum => {
        const count = passengersByFloor[floorNum].length;
        const item = document.createElement('div');
        item.className = 'flex justify-between items-center text-sm bg-slate-50 p-2 rounded border border-slate-100';
        
        item.innerHTML = `
          <span class="font-mono font-bold text-slate-600">${floorNum}层</span>
          <div class="flex items-center gap-2">
            <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500" style="width: ${Math.min((count/10)*100, 100)}%"></div>
            </div>
            <span class="text-xs text-slate-500 w-8 text-right">${count} 人</span>
          </div>
        `;
        
        queueMonitor.appendChild(item);
      });
    }

    function updateAnalytics() {
      const config = SCENARIO_CONFIGS[state.scenario];
      const avgWaitTime = state.stats.servedCount === 0 ? 0 : (state.stats.totalWaitTime / state.stats.servedCount).toFixed(1);
      const currentRiding = state.passengers.filter(p => p.state === 'riding').length;
      
      // 更新基本指标
      document.getElementById('avg-wait-time').textContent = avgWaitTime;
      document.getElementById('served-count').textContent = state.stats.servedCount;
      document.getElementById('current-riding').textContent = `当前承载: ${currentRiding}`;
      
      // 更新等待时间颜色
      const waitTimeElement = document.getElementById('avg-wait-time');
      if (parseFloat(avgWaitTime) > config.targetWaitTime) {
        waitTimeElement.classList.remove('text-emerald-400');
        waitTimeElement.classList.add('text-red-400');
      } else {
        waitTimeElement.classList.remove('text-red-400');
        waitTimeElement.classList.add('text-emerald-400');
      }
      
      // 更新等待时间趋势图
      const chartContainer = document.getElementById('wait-time-chart');
      
      if (state.stats.waitHistory.length === 0) {
        chartContainer.innerHTML = `
          <div class="absolute w-full border-t border-red-300 border-dashed left-0 z-0 flex items-center" style="bottom: ${(config.targetWaitTime / 100) * 100}%">
            <span class="absolute -top-4 right-1 text-[10px] text-red-400 bg-white px-1">阈值 ${config.targetWaitTime}</span>
          </div>
          <div class="w-full h-full flex items-center justify-center text-xs text-slate-400">暂无数据</div>
        `;
        return;
      }
      
      // 渲染柱状图
      chartContainer.innerHTML = `
        <div class="absolute w-full border-t border-red-300 border-dashed left-0 z-0 flex items-center" style="bottom: ${(config.targetWaitTime / 100) * 100}%">
          <span class="absolute -top-4 right-1 text-[10px] text-red-400 bg-white px-1">阈值 ${config.targetWaitTime}</span>
        </div>
      `;
      
      state.stats.waitHistory.forEach((val, i) => {
        const heightPct = Math.min((val / 100) * 100, 100);
        const isOver = val > config.targetWaitTime;
        
        const barContainer = document.createElement('div');
        barContainer.className = 'flex-1 flex flex-col justify-end group relative z-10';
        
        const bar = document.createElement('div');
        bar.className = `w-full rounded-t-sm transition-all duration-300 ${isOver ? 'bg-red-400' : 'bg-emerald-400'}`;
        bar.style.height = `${heightPct}%`;
        
        const tooltip = document.createElement('div');
        tooltip.className = 'absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block bg-slate-800 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap';
        tooltip.textContent = `${Number(val).toFixed(1)}s`;
        
        barContainer.appendChild(bar);
        barContainer.appendChild(tooltip);
        chartContainer.appendChild(barContainer);
      });
    }

    // --- 事件监听器 ---
    function setupEventListeners() {
      // 场景切换
      document.querySelectorAll('.scenario-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const scenarioId = btn.id.replace('scenario-', '');
          state.scenario = scenarioId;
          
          const config = SCENARIO_CONFIGS[scenarioId];
          state.numFloors = config.defaultFloors;
          state.numElevators = config.defaultElevators;
          state.currentMode = config.defaultMode;
          
          pauseSimulation();
          resetSimulation();
          updateUI();
          renderBuilding();
        });
      });
      
      // 控制按钮
      document.getElementById('toggle-simulation').addEventListener('click', () => {
        if (state.isRunning) {
          pauseSimulation();
        } else {
          startSimulation();
        }
      });
      
      document.getElementById('reset-simulation').addEventListener('click', () => {
        pauseSimulation();
        resetSimulation();
      });
      
      document.getElementById('trigger-code-blue').addEventListener('click', triggerCodeBlue);
      
      // 参数滑块
      document.getElementById('num-floors').addEventListener('input', (e) => {
        state.numFloors = parseInt(e.target.value);
        document.getElementById('num-floors-value').textContent = `${state.numFloors}层`;
        renderBuilding();
      });
      
      document.getElementById('num-elevators').addEventListener('input', (e) => {
        state.numElevators = parseInt(e.target.value);
        document.getElementById('num-elevators-value').textContent = `${state.numElevators}部`;
        resetSimulation();
        renderBuilding();
      });
      
      document.getElementById('num-groups').addEventListener('input', (e) => {
        state.numGroups = parseInt(e.target.value);
        document.getElementById('num-groups-value').textContent = `${state.numGroups}组`;
        resetSimulation();
        renderBuilding();
      });
      
      document.getElementById('group-spacing').addEventListener('input', (e) => {
        state.groupSpacing = parseInt(e.target.value);
        document.getElementById('group-spacing-value').textContent = `${state.groupSpacing}单位`;
        renderBuilding();
      });
      
      document.getElementById('traffic-multiplier').addEventListener('input', (e) => {
        state.trafficMultiplier = parseFloat(e.target.value);
        document.getElementById('traffic-value').textContent = `x${state.trafficMultiplier}`;
      });
      
      document.getElementById('operating-mode').addEventListener('change', (e) => {
        state.currentMode = e.target.value;
      });
      
      // 速度控制
      document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const speed = parseInt(btn.textContent);
          state.simSpeed = speed;
          
          // 如果模拟正在运行，重新启动以应用新速度
          if (state.isRunning) {
            pauseSimulation();
            startSimulation();
          }
          
          updateUI();
        });
      });
    }

    // --- 初始化 ---
    function init() {
      setupEventListeners();
      updateUI();
      renderBuilding();
      resetSimulation();
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>